(()=>{"use strict";(()=>{const e={disableFormElements(e){for(let t=0;t<e.length;t++)e[t].disabled=!0},enableFormElements(e){for(let t=0;t<e.length;t++)e[t].disabled=!1},debounce(e){let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}},showError(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red; max-width: 1200px",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},showSuccessSave(){const e=document.querySelector("#success").content.cloneNode(!0);document.querySelector("main").appendChild(e);const t=()=>{document.querySelector("main").removeChild(document.querySelector(".success")),document.removeEventListener("mousedown",o),document.removeEventListener("keydown",n)},n=e=>{"Escape"===e.key&&t()},o=()=>{t()};document.addEventListener("mousedown",o),document.addEventListener("keydown",n)},showErrorSave(){const e=document.querySelector("#error").content.cloneNode(!0);document.querySelector("main").appendChild(e);const t=()=>{document.querySelector("main").removeChild(document.querySelector(".error")),document.removeEventListener("mousedown",n),document.removeEventListener("keydown",o)},n=()=>{t()},o=e=>{"Escape"===e.key&&t()};document.querySelector(".error__button").addEventListener("click",(()=>{t()})),document.addEventListener("mousedown",n),document.addEventListener("keydown",o)}};window.util=e})(),(()=>{const e={save(e,t,n){const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{switch(o.status){case 200:t();break;case 500:n();break;case 404:n("Ничего не найдено");break;default:n()}})),o.addEventListener("error",(()=>{n()})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)},load(e,t){const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{switch(n.status){case 200:e(n.response);break;case 400:t("Неверный запрос");break;case 404:t("Ничего не найдено");break;default:t(`Статус ответа: : ${n.status} ${n.statusText}`)}})),n.addEventListener("error",(()=>{t("Ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Ошибка соединения. Превышено время ожидания")})),n.timeout=1e4,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()}};window.backend=e})(),(()=>{const e="Квартира",t="Бунгало",n="Дом",o="Дворец";window.createHiddenCard=r=>{const a=document.querySelector("#card").content.cloneNode(!0);a.querySelector(".popup__title").textContent=r.offer.title,a.querySelector(".popup__text--address").textContent=r.offer.address,a.querySelector(".popup__text--price").textContent=r.offer.price+"₽/ночь";const s=a.querySelector(".popup__type");switch(r.offer.type){case"flat":s.textContent=e;break;case"bungalow":s.textContent=t;break;case"house":s.textContent=n;break;case"palace":s.textContent=o;break;default:s.textContent="Любой тип жилья"}a.querySelector(".popup__text--capacity").textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`,a.querySelector(".popup__text--time").textContent=`Заезд после ${r.offer.checkin}, выезд до ${r.offer.checkout}`;const c=a.querySelector(".popup__features"),d=a.querySelector(".popup__feature");c.innerHTML="";for(let e=0;e<r.offer.features.length;e++){const t=d.cloneNode();t.classList.remove(),t.classList.add("popup__feature"),t.classList.add("popup__feature--"+r.offer.features[e]),c.appendChild(t)}a.querySelector(".popup__description").textContent=r.offer.description;const l=a.querySelector(".popup__photos"),u=a.querySelector(".popup__photo");l.innerHTML="";for(let e=0;e<r.offer.photos.length;e++){let t=u.cloneNode();t.src=r.offer.photos[e],l.appendChild(t)}return a.querySelector(".popup__avatar").src=""+r.author.avatar,a.querySelector(".map__card").classList.add("hidden"),a}})(),window.createPin=e=>{const t=document.querySelector("#pin").content.cloneNode(!0);t.querySelector(".map__pin").style.cssText=`left: ${e.location.x-25}px; top: ${e.location.y-70}px;`;const n=t.querySelector("img");return n.src=""+e.author.avatar,n.alt=""+e.offer.title,t},(()=>{const e=window.createPin,t=window.createHiddenCard,n={clean(){document.querySelectorAll(".map__pin").forEach((e=>{e.classList.contains("map__pin--main")||e.remove()})),document.querySelectorAll(".map__card").forEach((e=>e.remove()))},render(n){const o=document.querySelector(".map"),r=document.querySelector(".map__pins");this.clean();const a=document.createDocumentFragment();for(let r=0;r<n.length;r++)n[r].hasOwnProperty("offer")&&(a.appendChild(e(n[r])),o.insertBefore(t(n[r]),document.querySelector(".map__filters-container")));r.appendChild(a)}};window.pinsAndCards=n})(),(()=>{const e=window.util,t=window.pinsAndCards;let n="any",o="any",r="any",a="any",s=[],c=[],d=null,l=null;const u=(e,t=!0)=>{let n;n=t?r:a;const o=[];for(let r=0;r<e.length;r++)"any"===n?o.push(e[r]):t?+n===e[r].offer.rooms&&o.push(e[r]):+n===e[r].offer.guests&&o.push(e[r]);return o},i=()=>{const e=(e=>{const t=[];for(let n=0;n<e.length;n++)"any"===o?t.push(e[n]):"middle"===o?e[n].offer.price>=1e4&&e[n].offer.price<=5e4&&t.push(e[n]):"low"===o?e[n].offer.price<=1e4&&t.push(e[n]):"high"===o&&e[n].offer.price>=5e4&&t.push(e[n]);return t})((e=>{const t=[];for(let o=0;o<e.length;o++)("any"===n||n===e[o].offer.type)&&t.push(e[o]);return t})(c)),r=u(e),a=(e=>{const t=[],n=e=>{for(let t=0;t<s.length;t++)if(-1===e.indexOf(s[t]))return!1;return!0};for(let o=0;o<e.length&&((0===s.length||n(e[o].offer.features))&&t.push(e[o]),!(t.length>4));o++);return t})(u(r,!1));t.render(a),f()},m=e=>{"Escape"===e.key&&y(l,d)},p=(e,t)=>{d=t,l=e;const n=document.querySelectorAll(".map__card"),o=Array.from(document.querySelectorAll(".map__pin")).filter((e=>!e.classList.contains("map__pin--main")));for(let e=0;e<n.length;e++)n[e].classList.contains("hidden")||y(n[e],o[e]);e.classList.remove("hidden"),t.classList.add("map__pin--active"),document.addEventListener("keydown",m)},y=(e,t)=>{e.classList.add("hidden"),t.classList.remove("map__pin--active"),document.removeEventListener("keydown",m)},f=()=>{const e=Array.from(document.querySelectorAll(".map__pin")).filter((e=>!e.classList.contains("map__pin--main"))),t=document.querySelectorAll(".map__card");for(let n=0;n<e.length;n++)e[n].addEventListener("click",(()=>{p(t[n],e[n])})),t[n].querySelector(".popup__close").addEventListener("click",(()=>{y(t[n],e[n])}))},_={resetPinsFilters(){n="any",o="any",r="any",a="any",s=[],c=[]},addFilterHandlers(){const t=document.querySelector("select[name=housing-type]"),c=document.querySelector("select[name=housing-price]"),d=document.querySelector("select[name=housing-rooms]"),l=document.querySelector("select[name=housing-guests]"),u=document.querySelectorAll(".map__checkbox");t.addEventListener("change",e.debounce((()=>{n=t.value,i()}))),c.addEventListener("change",e.debounce((()=>{o=c.value,i()}))),d.addEventListener("change",e.debounce((()=>{r=d.value,i()}))),l.addEventListener("change",e.debounce((()=>{a=l.value,i()})));for(let t=0;t<u.length;t++)u[t].addEventListener("click",e.debounce((()=>{u[t].checked?s.push(u[t].value):s.splice(s.indexOf(u[t].value),1),i()})))},successHandler(t){const n=document.querySelector(".map__filters").children;e.enableFormElements(n),c=t,i()},errorHandler(t){e.showError(t)}};window.map=_})(),(()=>{const e=document.querySelector(".map__pin--main").style.left,t=document.querySelector(".map__pin--main").style.top,n=window.pinsAndCards,o=window.util,r=window.map,a={MAIN_PIN_HEIGHT:83,MAIN_PIN_WIDTH:66,getCoordinates(e){return`${parseInt(e.style.left,10)+this.MAIN_PIN_WIDTH/2}, ${parseInt(e.style.top,10)+this.MAIN_PIN_HEIGHT}`},disable(){const s=document.querySelector(".map__pin--main");document.querySelector(".map").classList.add("map--faded"),document.querySelector(".ad-form").reset(),document.querySelector(".ad-form").classList.add("ad-form--disabled"),document.querySelector(".map__filters").reset(),n.clean(),o.disableFormElements(document.querySelector(".ad-form").children),o.disableFormElements(document.querySelector(".map__filters").children),window.scroll(0,0),r.resetPinsFilters(),s.style.left=e,s.style.top=t,document.querySelector("input[name=address]").value=a.getCoordinates(document.querySelector(".map__pin--main")),document.querySelector(".ad-form__photo").innerHTML="",document.querySelector(".ad-form-header__preview").querySelector("img").src="img/muffin-grey.svg"}};window.page=a})(),(()=>{const e=["gif","jpg","jpeg","png","svg"];let t=1e3;const n=window.page,o=window.util,r=window.backend,a=()=>{const e=document.querySelector("input[name=price]");t=1e3,e.placeholder=t},s=(e,t)=>{e.addEventListener("change",(()=>{switch(e.value){case"12:00":t.selectedIndex=0;break;case"13:00":t.selectedIndex=1;break;case"14:00":t.selectedIndex=2;break;default:t.selectedIndex=0}}))},c=(t,n,o=!0)=>{t.addEventListener("change",(function(){const r=t.files[0],a=r.name.toLowerCase();if(e.some((function(e){return a.endsWith(e)}))){t.setCustomValidity("");const e=new FileReader;e.addEventListener("load",(function(){if(o)n.src=e.result;else{n.innerHTML="";const t=document.createElement("img");t.width=70,t.height=70,t.src=e.result,t.alt="House Photo",n.appendChild(t)}})),e.readAsDataURL(r)}else t.setCustomValidity("Файл не является изображением!")}))};window.addAdFormHandlers=()=>{const e=document.querySelector(".ad-form"),d=document.querySelector(".ad-form__reset"),l=document.querySelector("input[name=title]"),u=document.querySelector("input[name=price]"),i=document.querySelector("select[name=type]"),m=document.querySelector("select[name=rooms]"),p=document.querySelector("select[name=capacity]"),y=document.querySelector(".ad-form__submit"),f=document.querySelector("select[name=timein]"),_=document.querySelector("select[name=timeout]"),h=document.querySelector(".ad-form-header__input"),v=document.querySelector(".ad-form-header__preview").querySelector("img"),w=document.querySelector(".ad-form__input"),S=document.querySelector(".ad-form__photo");c(h,v),c(w,S,!1),l.addEventListener("input",(()=>{const e=l.value.length;e<30?l.setCustomValidity("Ещё "+(30-e)+" симв."):e>100?l.setCustomValidity("Удалите лишние "+(e-100)+" симв."):l.setCustomValidity("")})),u.addEventListener("input",(()=>{u.value=u.value.replace(/[^0-9.]/g,"")})),i.addEventListener("change",(()=>{switch(i.value){case"bungalow":t=0,u.placeholder=t;break;case"flat":t=1e3,u.placeholder=t;break;case"house":t=5e3,u.placeholder=t;break;case"palace":t=1e4,u.placeholder=t;break;default:t=1e3,u.placeholder=t}})),s(f,_),s(_,f),y.addEventListener("click",(()=>{1==+m.value&&1!=+p.value?m.setCustomValidity("1 комнатная квартира только для 1 гостя!"):2==+m.value&&(+p.value>2||0==+p.value)?m.setCustomValidity("2 комнатная квартира только для 1 или 2 гостей!"):3==+m.value&&(+p.value>3||0==+p.value)?m.setCustomValidity("3 комнатная квартира только для 1, 2 или 3 гостей!"):100==+m.value&&0!=+p.value?m.setCustomValidity("100 комнатные помещения не для гостей!"):m.setCustomValidity(""),u.value>1e6?u.setCustomValidity("Максимальная цена составляет: 1000000"):u.value<t?u.setCustomValidity(`Минимальная цена для данного типа жилья составляет ${t} рублей`):u.setCustomValidity("")})),d.addEventListener("click",(()=>{n.disable(),a()})),e.addEventListener("submit",(t=>{t.preventDefault(),r.save(new FormData(e),(()=>{n.disable(),a(),o.showSuccessSave()}),o.showErrorSave)}))}})(),(()=>{const e=document.querySelector(".map__overlay").clientWidth,t=window.page,n=window.backend,o=window.util,r=window.map,a=()=>{const e=document.querySelector(".map"),a=document.querySelector(".map__pin--main"),s=document.querySelector(".ad-form").children,c=document.querySelector(".ad-form"),d=document.querySelector("input[name=address]");o.enableFormElements(s),n.load(r.successHandler,r.errorHandler),d.value=t.getCoordinates(a),e.classList.remove("map--faded"),c.classList.remove("ad-form--disabled")};window.addMainPinHandlers=()=>{const n=document.querySelector(".map"),o=document.querySelector(".map__pin--main");o.addEventListener("mousedown",(r=>{if(r.preventDefault(),0===r.button){n.classList.contains("map--faded")&&a();const s=document.querySelector("input[name=address]");let c={x:r.clientX,y:r.clientY};const d=n=>{n.preventDefault();const r=c.x-n.clientX,a=c.y-n.clientY;c={x:n.clientX,y:n.clientY},o.offsetTop-a+t.MAIN_PIN_HEIGHT>=130&&o.offsetTop-a+t.MAIN_PIN_HEIGHT<=630&&o.offsetLeft-r+t.MAIN_PIN_WIDTH/2>=0&&o.offsetLeft-r+t.MAIN_PIN_WIDTH/2<=e&&(o.style.top=o.offsetTop-a+"px",o.style.left=o.offsetLeft-r+"px",s.value=t.getCoordinates(document.querySelector(".map__pin--main")))},l=e=>{e.preventDefault(),s.value=t.getCoordinates(document.querySelector(".map__pin--main")),document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",l)}})),o.addEventListener("keydown",(e=>{"Enter"===e.key&&r.classList.contains("map--faded")&&a()}))}})(),(()=>{const e=window.addMainPinHandlers,t=window.addAdFormHandlers,n=window.map,o=window.page,r=window.util;document.querySelector("input[name=address]").value=o.getCoordinates(document.querySelector(".map__pin--main")),r.disableFormElements(document.querySelector(".ad-form").children),r.disableFormElements(document.querySelector(".map__filters").children),e(),t(),n.addFilterHandlers()})()})();